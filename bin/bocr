#!/usr/bin/env python
# -*- coding: utf-8 -*-

from __future__ import print_function

import sys
import argparse
from os import getenv
from os.path import join, abspath
from operator import itemgetter

from baiduocr import BaiduOcr


KEY_FILE = join(getenv('HOME'), '.bocr_key')

SERVICE_LIST = {
    0: 'LocateRecognize',
    1: 'Recognize',
    2: 'Locate',
    3: 'SingleCharRecognize',
}


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Recognize text from picuture.')
    parser.add_argument('-i', '--input', type=str,
                        help='specify picture want to recognize')
    parser.add_argument('-s', '--service', type=int,
                        help='choose service from LocateRecognize(0), Recognize(1, default), Locate(2), SingleCharRecognize(3)')
    parser.add_argument('-l', '--lang', type=str,
                        help='specify language of text to be detected, chn_eng(default), eng, jap or kor')

    args = parser.parse_args()

    image_file = args.input
    service = SERVICE_LIST.get(1 if not args.service else args.service, None)
    lang = 'chn_eng' if not args.lang else args.lang

    # 参数检查
    if not image_file:
        print 'no image file is given.'
        parser.print_help()
        sys.exit(1)

    if not service:
        print('invalid service')
        parser.print_help()
        sys.exit(1)

    if lang not in ('chn_eng', 'eng', 'jap', 'kor'):
        print('unknown language type: %s' % lang)
        parser.print_help()
        sys.exit(1)

    try:
        api_key = open(KEY_FILE, 'r').read().strip()
    except IOError as e:
        print('Error: No API key found in %s' % abspath(join(getenv('HOME'), '.bocr_key')))
        sys.exit(1)

    client = BaiduOcr(key=api_key)
    res = client.recog(image_file, service=service, lang=lang.upper())

    if res.status != 0:
        print('Error:', res.status, res.message)

    else:
        if service in ('LocateRecognize', 'Recognize'):
            print(res.get_result_text())
        elif service == 'Locate':
            for rect in res.get_result_regions():
                print(rect.left, rect.width, rect.top, rect.height)
        elif service == 'SingleCharRecognize':
            print(res.get_char())
